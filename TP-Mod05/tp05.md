# TP Chapitre 5 ‚Äì Automatisation du d√©ploiement üöÄ

## Contexte / Storytelling
La startup GFP Tech a maintenant un pipeline complet pour les builds et tests.  
Il est temps de passer √† **l‚Äôautomatisation du d√©ploiement** afin de livrer rapidement les artefacts sur les environnements de staging et production, tout en assurant des m√©canismes de rollback s√©curis√©s.

---

## Objectifs p√©dagogiques
- Automatiser le d√©ploiement d‚Äôun artefact Maven ou Docker.  
- Mettre en place des scripts de d√©ploiement fiables.  
- Int√©grer un m√©canisme de rollback simple pour revenir √† une version stable.  
- D√©ployer sur diff√©rents environnements selon les param√®tres.

---

## Pr√©requis techniques
- Jenkins avec pipelines Chapitre 1 √† 4.  
- Projet Maven avec build et tests automatis√©s.  
- Docker install√© sur l‚Äôagent ou le serveur cible.  
- Acc√®s SSH √† un environnement staging ou serveur de test.

---

## √âtapes d√©taill√©es

### **1. Pr√©parer le script de d√©ploiement**
Cr√©er un script `deploy.sh` dans le projet :

```bash
#!/bin/bash
ENV=$1
IMAGE_TAG=$2

echo "D√©ploiement sur l'environnement $ENV avec l'image $IMAGE_TAG"

docker pull gfptech/app:$IMAGE_TAG || { echo "√âchec pull"; exit 1; }
docker stop app-$ENV || true
docker rm app-$ENV || true
docker run -d --name app-$ENV -p 8080:8080 gfptech/app:$IMAGE_TAG
```
- Param√®tres : environnement (`dev`, `staging`, `prod`) et tag Docker.

### **2. Modifier le Jenkinsfile pour inclure le d√©ploiement**
Ajouter un stage dans le pipeline :

```groovy
stage('Deploy') {
    steps {
        script {
            def envTarget = params.ENV ?: 'staging'
            def imageTag = "${env.BUILD_NUMBER}"
            sh "./deploy.sh ${envTarget} ${imageTag}"
        }
    }
    post {
        success {
            echo "‚úÖ D√©ploiement r√©ussi"
        }
        failure {
            echo "‚ö†Ô∏è √âchec du d√©ploiement, rollback n√©cessaire"
        }
    }
}
```

### **3. Ajouter un m√©canisme de rollback simple**
1. Conserver la derni√®re image stable Docker.  
2. En cas d‚Äô√©chec, ex√©cuter :

```bash
docker stop app-$ENV
docker rm app-$ENV
docker run -d --name app-$ENV gfptech/app:last-stable
```

3. Optionnel : notifier l‚Äô√©quipe via Slack ou Email.

### **4. Tester le pipeline**
1. D√©clencher le pipeline sur l‚Äôenvironnement `staging`.  
2. V√©rifier que l‚Äôimage Docker est d√©ploy√©e correctement.  
3. Simuler un √©chec (ex: tag incorrect) et observer le rollback.  
4. Tester les notifications et logs.

---

## Livrable final
- Pipeline Jenkins avec :  
  - Build et tests automatis√©s  
  - D√©ploiement Docker automatis√© sur environnement staging/production  
  - Rollback automatique en cas d‚Äô√©chec  
- Script `deploy.sh` fonctionnel et test√©  
- Logs et notifications disponibles pour l‚Äô√©quipe

---

## Bonus (optionnel)
- D√©ploiement conditionnel selon branche (feature ‚Üí staging, release ‚Üí prod).  
- D√©ploiement multistage avec Canary ou Blue-Green.  
- Ajout d‚Äôune √©tape de migration base de donn√©es si n√©cessaire.
~~~

