# TP Chapitre 9 ‚Äì Int√©gration Sonar, Nexus et Docker üèóÔ∏è

## Contexte / Storytelling
La startup GFP Tech a maintenant des pipelines multibranch et une gestion GitFlow en place.  
Pour renforcer la **qualit√©, la s√©curit√© et la distribution des artefacts**, il est temps d‚Äôint√©grer **SonarQube, Nexus et Docker** dans le pipeline.  
L‚Äôobjectif est de construire, analyser, stocker et d√©ployer automatiquement vos artefacts.

---

## Objectifs p√©dagogiques
- Ajouter l‚Äôanalyse de code avec **SonarQube** dans le pipeline Jenkins.  
- Publier les artefacts Maven sur **Nexus**.  
- Construire et pousser des images **Docker** automatiquement.  
- Int√©grer toutes ces √©tapes dans le pipeline multibranch existant.  

---

## Pr√©requis techniques
- Jenkins avec pipelines Chapitre 1 √† 8.  
- SonarQube accessible avec token.  
- Nexus Repository Manager configur√© avec un repository Maven.  
- Docker install√© et configur√© pour push/pull.  
- Projet Maven pr√™t avec tests unitaires.

---

## √âtapes d√©taill√©es

### **1. Int√©gration SonarQube**
1. Installer le plugin **SonarQube Scanner** dans Jenkins.  
2. Configurer SonarQube dans **Manage Jenkins ‚Üí Configure System** avec token.  
3. Ajouter un stage dans le `Jenkinsfile` :

```groovy
stage('SonarQube Analysis') {
    environment {
        SONAR_HOST_URL = 'http://sonarqube:9000'
        SONAR_AUTH_TOKEN = credentials('sonar-token')
    }
    steps {
        sh "mvn sonar:sonar -Dsonar.projectKey=demo-app -Dsonar.host.url=${SONAR_HOST_URL} -Dsonar.login=${SONAR_AUTH_TOKEN}"
    }
}
```

### **2. Publier les artefacts sur Nexus**
1. Configurer les credentials Nexus dans Jenkins (`nexus-credentials`).  
2. Ajouter un stage pour publier les artefacts :

```groovy
stage('Publish to Nexus') {
    steps {
        sh """
        mvn deploy -DaltDeploymentRepository=nexus::default::http://nexus:8081/repository/maven-releases/
        """
    }
}
```

### **3. Construire et pousser Docker**
1. Cr√©er un `Dockerfile` dans le projet si pas encore existant :

```dockerfile
FROM openjdk:17-jdk
COPY target/demo-app.jar /app/demo-app.jar
WORKDIR /app
ENTRYPOINT ["java", "-jar", "demo-app.jar"]
```

2. Ajouter un stage Docker dans le pipeline :

```groovy
stage('Build Docker Image') {
    steps {
        script {
            def imageTag = "gfptech/demo-app:${env.BUILD_NUMBER}"
            sh "docker build -t ${imageTag} ."
            sh "docker push ${imageTag}"
        }
    }
}
```

### **4. Int√©grer le tout dans le pipeline multibranch**
1. V√©rifier que le pipeline d√©tecte toutes les branches.  
2. Configurer les √©tapes conditionnelles selon GitFlow :  
   - Feature branches : build + tests + SonarQube  
   - Release branches : build + tests + SonarQube + Nexus + Docker staging  
   - Main : build + tests + SonarQube + Nexus + Docker prod

### **5. Tester le pipeline**
1. Cr√©er un commit sur une feature branch et v√©rifier :  
   - Build Maven OK  
   - Tests OK  
   - Analyse SonarQube ex√©cut√©e
2. Cr√©er un release branch et v√©rifier publication sur Nexus et build Docker.  
3. V√©rifier la coh√©rence des artefacts et images Docker.

---

## Livrable final
- Pipeline multibranch complet int√©grant :  
  - Build et tests Maven  
  - Analyse SonarQube  
  - Publication sur Nexus  
  - Build et push Docker  
- Artefacts et images Docker disponibles pour tous les environnements.

---

## Bonus (optionnel)
- Ajouter des **qualit√© gates SonarQube** pour bloquer le build si couverture insuffisante.  
- D√©ployer Docker automatiquement sur un environnement staging ou prod via script ou Kubernetes.  
- Ajouter notifications Slack ou Email apr√®s chaque publication d‚Äôartefact.
~~~

