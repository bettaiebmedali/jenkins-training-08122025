TP Administration Jenkins 1
Agent Jenkins Offline / en erreur JNLP ou SSH
ğŸ¯ Objectif

Diagnostiquer, rÃ©parer et remettre en ligne un agent Jenkins cassÃ©.

ğŸ§© Situation rÃ©elle

Un agent Jenkins Linux est marquÃ© :

Agent is offline  
No connection to agent  
Waiting for next available executor


Les pipelines sont bloquÃ©s.

ğŸ› ï¸ Ã‰tapes Ã  rÃ©aliser
### 1. VÃ©rifier lâ€™Ã©tat du service agent

Sur la machine agent :

systemctl status jenkins-agent
journalctl -u jenkins-agent -n 50

2. RedÃ©marrer lâ€™agent
systemctl restart jenkins-agent

3. VÃ©rifier la connectivitÃ© rÃ©seau

Depuis le master :

ping <agent-ip>
nc -z <agent-ip> 50000

4. VÃ©rifier la configuration dans Jenkins

Dans Manage Jenkins â†’ Nodes :

VÃ©rifier la clÃ© secrÃ¨te JNLP

VÃ©rifier le bon chemin du workDir

5. Reconnecter manuellement

Jenkins â†’ Node â†’ "Reconnect"

âœ” RÃ©sultat attendu

Lâ€™agent apparaÃ®t Online et exÃ©cute Ã  nouveau les pipelines.

Agent is connected and ready


---

# ```md
# TP Administration Jenkins 2  
## Jenkins saturÃ© : "No space left on device"

### ğŸ¯ Objectif  
LibÃ©rer lâ€™espace disque, analyser les causes et mettre en place un housekeeping.

---

## ğŸ§© ProblÃ¨me rÃ©el  
Erreur dans les builds :


java.io.IOException: No space left on device


---

## ğŸ› ï¸ Ã‰tapes

### 1. VÃ©rifier lâ€™espace disque
```bash
df -h
du -sh /var/lib/jenkins/*

2. Nettoyer les workspaces Jenkins
rm -rf /var/lib/jenkins/workspace/* 

3. Nettoyer les anciens builds
find /var/lib/jenkins/jobs/*/builds -type d -mtime +15 -exec rm -rf {} \;

4. Activer la rotation des builds

Job â†’ Configure â†’ Build Discarder :

Keep 20 builds
Keep artifacts: 10 days

5. Si Docker est utilisÃ© : clean
docker system prune -af

âœ” RÃ©sultat attendu

Le disque retombe sous 70 % et Jenkins redevient stable.


---

# ```md
# TP Administration Jenkins 3  
## Gestion des permissions et erreurs 403 (RBAC)

### ğŸ¯ Objectif  
RÃ©soudre les erreurs 403 et configurer des rÃ´les corrects.

---

## ğŸ§© Contexte rÃ©el  
Un utilisateur ne peut pas lancer un job :


Access Denied (403)
You need the Job/Build permission


---

## ğŸ› ï¸ Ã‰tapes

### 1. Activer Matrix Authorization Strategy  
Manage Jenkins â†’ Security

Activer :


Project-based Matrix Authorization Strategy


### 2. CrÃ©er des rÃ´les
- `developer` : Read + Build  
- `maintainer` : Configure + Read  
- `admin` : Full Control  

### 3. Assigner les utilisateurs  
Security â†’ Assign Roles

### 4. Debug des erreurs CRUMB  
Manage Jenkins â†’ Configure Global Security :
- Activer/dÃ©sactiver CSRF pour test  
- VÃ©rifier Reverse Proxy  

---

## âœ” RÃ©sultat  
L'utilisateur peut utiliser le job sans ouvrir trop de permissions.

```md
TP Administration Jenkins 4
Credentials mal gÃ©rÃ©s (mots de passe exposÃ©s)
ğŸ¯ Objectif

SÃ©curiser les secrets et corriger les pipelines dangereux.

ğŸ§© Situation rÃ©elle

Un dÃ©veloppeur a mis dans son Jenkinsfile :

sh 'docker login -u toto -p password123'

ğŸ› ï¸ Ã‰tapes
1. CrÃ©er un credentials sÃ©curisÃ©

Credentials â†’ System â†’ Global :

ID : docker-pass

Type : Secret Text

2. Corriger le Jenkinsfile
withCredentials([string(credentialsId: 'docker-pass', variable: 'PASS')]) {
    sh 'echo $PASS | docker login -u toto --password-stdin'
}

3. Scanner Jenkins pour secrets exposÃ©s
grep -R "password" /var/lib/jenkins/jobs/

âœ” RÃ©sultat

Plus aucun mot de passe nâ€™est visible en clair.


---

# ```md
# TP Administration Jenkins 5  
## Webhook GitHub ne dÃ©clenche pas Jenkins

### ğŸ¯ Objectif  
Corriger un pipeline qui ne se lance pas automatiquement aprÃ¨s un push.

---

## ğŸ§© ProblÃ¨me rÃ©el  
Github â†’ Webhooks indique :  


500 â€“ Connection refused
403 â€“ Forbidden


---

## ğŸ› ï¸ Ã‰tapes

### 1. VÃ©rifier lâ€™accÃ¨s public de Jenkins
```bash
curl -I http://<jenkins-url>/github-webhook/

2. VÃ©rifier la configuration du webhook

GitHub â†’ Settings â†’ Webhooks

Payload URL: https://jenkins.example.com/github-webhook/
Content-Type: application/json

3. Ajouter le trigger dans Jenkinsfile
triggers {
    githubPush()
}

4. VÃ©rifier les logs Jenkins

Manage Jenkins â†’ System Log :

Received POST from GitHub
Webhook successfully processed

âœ” RÃ©sultat

Un push sur GitHub dÃ©clenche immÃ©diatement un build Jenkins.


---

# ```md
# TP Administration Jenkins 6  
## Docker saturÃ© sur un agent Jenkins

### ğŸ¯ Objectif  
Diagnostiquer et nettoyer Docker pour rÃ©tablir les builds.

---

## ğŸ§© ProblÃ¨me  
Sur lâ€™agent :


Error: no space left on device
Cannot build Docker image


---

## ğŸ› ï¸ Ã‰tapes

### 1. Diagnostiquer docker  
```bash
docker system df
docker images
docker ps -a

2. Nettoyer
docker system prune -af
docker volume prune -f

3. Ajouter un cron automatique

CrÃ©er /etc/cron.weekly/docker-clean :

#!/bin/bash
docker system prune -af
docker volume prune -f

âœ” RÃ©sultat

Les builds Docker redeviennent fonctionnels.


---

# ```md
# TP Administration Jenkins 7  
## Plugin mis Ã  jour â†’ Jenkins cassÃ©

### ğŸ¯ Objectif  
Diagnostiquer et restaurer un Jenkins aprÃ¨s une mise Ã  jour de plugins.

---

## ğŸ§© Contexte  
AprÃ¨s mise Ã  jour de plusieurs plugins, Jenkins ne dÃ©marre plus.

---

## ğŸ› ï¸ Ã‰tapes

### 1. DÃ©marrer en mode Safe Restart  
```bash
java -jar jenkins.war --safe

2. DÃ©sactiver un plugin cassÃ©

Supprimer le .jpi :

rm /var/lib/jenkins/plugins/<plugin>.jpi

3. Restaurer un plugin depuis backup

Copier depuis backup :

cp backup/plugins/<plugin>.jpi /var/lib/jenkins/plugins/

âœ” RÃ©sultat

Jenkins redÃ©marre et les jobs reprennent.


---

# ```md
# TP Administration Jenkins 8  
## ProblÃ¨mes Proxy / SSL / CSRF (403 No valid crumb)

### ğŸ¯ Objectif  
Corriger les erreurs dâ€™accÃ¨s dues au reverse proxy.

---

## ğŸ§© Situation rÃ©elle  
Navigateur :


HTTP 403 â€“ No valid crumb included


---

## ğŸ› ï¸ Ã‰tapes

### 1. VÃ©rifier Nginx  


proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-Proto https;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;


### 2. Configurer Jenkins URL  
Manage Jenkins â†’ Configure System :


Jenkins URL = https://jenkins.example.com/


### 3. Activer la compatibilitÃ© proxy  
Security â†’ Enable proxy compatibility

---

## âœ” RÃ©sultat  
Les formulaires Jenkins fonctionnent sans erreur 403.

```md
TP Administration Jenkins 9
Sauvegarde complÃ¨te & restauration Jenkins
ğŸ¯ Objectif

Sauvegarder Jenkins et restaurer une instance en cas de crash.

ğŸ§© Contexte rÃ©el

Le dossier jobs/ est supprimÃ© â†’ plus aucun pipeline.

ğŸ› ï¸ Ã‰tapes
1. Sauvegarde manuelle
tar czf jenkins-backup.tar.gz \
  /var/lib/jenkins/jobs \
  /var/lib/jenkins/secrets \
  /var/lib/jenkins/plugins \
  /var/lib/jenkins/config.xml \
  /var/lib/jenkins/credentials.xml

2. Restauration

Sur un nouveau serveur :

systemctl stop jenkins
tar xzf jenkins-backup.tar.gz -C /var/lib/jenkins
systemctl start jenkins

âœ” RÃ©sultat

Jenkins retrouve exactement son Ã©tat initial.


---

# ```md
# TP Administration Jenkins 10  
## Performance : Jenkins trop lent / builds en attente

### ğŸ¯ Objectif  
Optimiser un Jenkins surchargÃ©.

---

## ğŸ§© ProblÃ¨me rÃ©el  
- Files dâ€™attente longues  
- Builds lents  
- CPU master saturÃ©

---

## ğŸ› ï¸ Ã‰tapes

### 1. Augmenter les agents  
Ajouter 2 nouveaux agents Linux.

### 2. RÃ©duire les executors sur le master  
Manage Jenkins â†’ Nodes :


Master executors = 0


### 3. Activer caches Maven/Docker  
Sur les agents :
```bash
~/.m2/repository
/var/lib/docker

4. DÃ©sactiver les jobs inutiles

Dashboard â†’ Disable Job

5. Installer le plugin Monitoring

Analyser :

CPU Usage

Queue Length

Thread counts

âœ” RÃ©sultat

Les temps dâ€™exÃ©cution chutent de 30 Ã  60 %.